<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller = function ($scope, spUtil, $location, $timeout) {
	var c = this;

	c.submitting = false;
	c.success = false;
	c.error = '';

	c.register = function () {

		if (c.submitting) return;

		c.submitting = true;
		c.success = false;
		c.error = '';

		// SAME BINDING STYLE
		$scope.data.action = 'register';
		$scope.data.registration = {
			course: $scope.data.course.sys_id
		};

		$scope.server.update().then(function (response) {
			c.submitting = false;

			if (response && response.success) {
				c.success = true;
				spUtil.addInfoMessage('You have been successfully registered');

				setTimeout(function () {
					window.location.href = '?id=user_dashboard';
				}, 1200);
			}
			else {
				c.error = response.error || 'Registration failed';
			}
		});
	};
};
]]></client_script>
        <controller_as>c</controller_as>
        <css>/* ===============================
   CARD CONTAINER
   =============================== */
.course-register-card {
  background: #ffffff;
  border-radius: 22px;
  padding: 28px;
  max-width: 520px;
  margin: 20px auto;
  box-shadow: 0 16px 40px rgba(0,0,0,0.08);
}

/* ===============================
   HEADER
   =============================== */
.register-header h3 {
  font-size: 22px;
  font-weight: 800;
  color: #0f172a;
  margin-bottom: 4px;
}

.register-header .subtitle {
  font-size: 14px;
  color: #64748b;
  margin-bottom: 22px;
}

/* ===============================
   FORM
   =============================== */
.form-group.modern {
  margin-bottom: 18px;
}

.form-group.modern label {
  display: block;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0.6px;
  text-transform: uppercase;
  color: #64748b;
  margin-bottom: 6px;
}

.modern-input {
  width: 100%;
  padding: 14px 16px;
  border-radius: 14px;
  border: 1px solid #e5e7eb;
  background: #f9fafb;
  font-size: 15px;
  font-weight: 600;
  color: #0f172a;
}

/* ===============================
   SEAT INFO
   =============================== */
.seat-info {
  background: #f0fdf4;
  border-radius: 14px;
  padding: 14px 16px;
  margin: 18px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.seat-label {
  font-size: 13px;
  font-weight: 700;
  color: #166534;
}

.seat-count {
  font-size: 16px;
  font-weight: 800;
  color: #065f46;
}

.seat-warning {
  background: #fffbeb;
  color: #92400e;
  font-size: 14px;
  padding: 14px;
  border-radius: 14px;
  margin: 18px 0;
}

/* ===============================
   PRIMARY BUTTON
   =============================== */
.primary-action-btn {
  width: 100%;
  margin-top: 10px;
  padding: 16px;
  border-radius: 18px;
  border: none;
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: #ffffff;
  font-size: 15px;
  font-weight: 800;
  cursor: pointer;
  transition: all 0.25s ease;
}

.primary-action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 14px 30px rgba(34,197,94,0.4);
}

.primary-action-btn:disabled {
  background: #bbf7d0;
  cursor: not-allowed;
  box-shadow: none;
  transform: none;
}

/* ===============================
   FEEDBACK MESSAGES
   =============================== */
.success-msg {
  margin-top: 16px;
  background: #dcfce7;
  color: #166534;
  padding: 14px;
  border-radius: 14px;
  font-weight: 600;
  text-align: center;
}

.error-msg {
  margin-top: 16px;
  background: #fee2e2;
  color: #991b1b;
  padding: 14px;
  border-radius: 14px;
  font-weight: 600;
  text-align: center;
}
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>registration_form_widget</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>Registration Form Widget</name>
        <option_schema/>
        <public>false</public>
        <roles>x_1862243_training.training user</roles>
        <script><![CDATA[(function () {

    /* ---------------------------
       Load course details
    ----------------------------*/
    var courseId = $sp.getParameter('course_id');
    data.course = null;

    if (courseId) {
        var cGR = new GlideRecord('x_1862243_training_training_course_table');
        if (cGR.get(courseId)) {
            data.course = {
                sys_id: cGR.getUniqueValue(),
                name: cGR.getDisplayValue('course_name'),
                available: parseInt(cGR.getValue('available_seats'), 10) || 0,
                max: cGR.getValue('maximum_seats')
            };
        }
    }

	data.isWaitlist = ($sp.getParameter('waitlist') === 'true');
    data.learner_name = gs.getUserDisplayName();

    /* ---------------------------
       Handle registration
    ----------------------------*/
    if (input && input.action === 'register' && input.registration) {

        // ]]>ðŸ”’<![CDATA[ Duplicate check (CRITICAL)
        var dupGR = new GlideRecord('x_1862243_training_training_registration_table');
        dupGR.addQuery('course', input.registration.course);
        dupGR.addQuery('learner', gs.getUserID());
        dupGR.query();

        if (dupGR.hasNext()) {
            data.error = "You are already registered for this course.";
            return;
        }

        // Validate course
        var courseGR = new GlideRecord('x_1862243_training_training_course_table');
        if (!courseGR.get(input.registration.course)) {
            data.error = "Course not found.";
            return;
        }

        var available = parseInt(courseGR.getValue('available_seats'), 10) || 0;
var isWaitlist = data.isWaitlist === true;

if (available <= 0 && !isWaitlist) {
    data.error = "No seats available.";
    return;
}


        // Insert registration
        var regGR = new GlideRecord('x_1862243_training_training_registration_table');
        regGR.initialize();
        regGR.setValue('course', input.registration.course);
        regGR.setValue('learner', gs.getUserID());
regGR.setValue('registration_status', isWaitlist ? 'waitlisted' : 'registered');
        regGR.setValue('certificate_issued', true);
        regGR.setValue('registration_date', new GlideDate().getValue());
        regGR.setValue('completion_date', courseGR.getValue('course_end_date'));


        var regId = regGR.insert();
        if (!regId) {
            data.error = regGR.getLastErrorMessage() || 'Registration failed.';
            return;
        }

        // Update available seats
if (!isWaitlist) {
    courseGR.setValue('available_seats', available - 1);
    courseGR.update();
}


        data.success = true;
        return;
    }

})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-11 13:29:25</sys_created_on>
        <sys_id>9ee71e3e8396b21084ade7d0deaad314</sys_id>
        <sys_mod_count>46</sys_mod_count>
        <sys_name>Registration Form Widget</sys_name>
        <sys_package display_value="Training Registration and Certification Portal" source="x_1862243_training">cd4f29228352721084ade7d0deaad3c0</sys_package>
        <sys_policy/>
        <sys_scope display_value="Training Registration and Certification Portal">cd4f29228352721084ade7d0deaad3c0</sys_scope>
        <sys_update_name>sp_widget_9ee71e3e8396b21084ade7d0deaad314</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-15 08:52:20</sys_updated_on>
        <template><![CDATA[<div class="course-register-card">

  <!-- HEADER -->
  <div class="register-header">
    <h3>Course Registration</h3>
    <p class="subtitle">Confirm your enrollment details</p>
  </div>

  <!-- BODY -->
  <div class="register-body">

    <!-- Course Name -->
    <div class="form-group modern">
      <label>Course Name</label>
      <input type="text"
             class="modern-input"
             ng-model="data.course.name"
             placeholder="Select a course first"
             readonly>
    </div>

    <!-- Learner -->
    <div class="form-group modern">
      <label>Learner</label>
      <input type="text"
             class="modern-input"
             ng-model="data.learner_name"
             readonly>
    </div>

    <!-- Seats Info -->
    <div class="seat-info" ng-if="data.course">
      <span class="seat-label">Available Seats</span>
      <span class="seat-count">
        {{data.course.available}} / {{data.course.max}}
      </span>
    </div>

    <div class="seat-warning" ng-if="!data.course">
      Please select a course to enable registration.
    </div>

    <!-- ACTION BUTTON -->
    <button class="primary-action-btn"
            ng-disabled="!data.course ||
                         !data.course.sys_id ||
                         c.submitting ||
                         (!data.isWaitlist && data.course.available <= 0)"
            ng-click="c.register()">
      {{ data.isWaitlist ? 'Join Waitlist' : 'Confirm Registration' }}
    </button>

    <!-- SUCCESS / ERROR -->
    <div class="success-msg" ng-if="c.success">
      Registration successful!
    </div>

    <div class="error-msg" ng-if="c.error">
      {{c.error}}
    </div>

  </div>
</div>
]]></template>
    </sp_widget>
    <sys_es_latest_script action="INSERT_OR_UPDATE">
        <id>9ee71e3e8396b21084ade7d0deaad314</id>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-15 08:52:18</sys_created_on>
        <sys_id>06de318c83e23a1084ade7d0deaad36f</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-15 08:52:18</sys_updated_on>
        <table>sp_widget</table>
        <use_es_latest>true</use_es_latest>
    </sys_es_latest_script>
</record_update>
