<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller = function ($scope, $location) {

  $scope.goToRegistration = function () {
    var courseId = $scope.data.course.sys_id;
    $location.url('?id=course_registration&course_id=' + courseId);
  };

	$scope.goToWaitlist = function () {
  var courseId = $scope.data.course.sys_id;
  $location.url('?id=course_registration&course_id=' + courseId + '&waitlist=true');
};

};
]]></client_script>
        <controller_as>c</controller_as>
        <css>.course-container {
  margin-top: 16px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* Header */
.course-header {
  padding-bottom: 12px;
  border-bottom: 1px solid #e5e7eb;
}

.course-title {
  font-size: 22px;
  font-weight: 700;
  color: #0f172a;
}

.course-code {
  font-size: 13px;
  font-weight: 500;
  color: #64748b;
  margin-left: 6px;
}

/* Overview */
.course-overview {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 24px;
  background: #ffffff;
  border-radius: 14px;
  border: 1px solid #e5e7eb;
  padding: 20px;
}

/* Info */
.course-description {
  font-size: 14px;
  color: #475569;
  margin-bottom: 16px;
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 14px;
}

.info-label {
  font-size: 11px;
  font-weight: 600;
  color: #64748b;
  text-transform: uppercase;
}

.info-value {
  font-size: 14px;
  font-weight: 600;
  color: #111827;
}

.info-chip {
  background: #eef2ff;
  color: #3730a3;
  font-size: 12px;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 999px;
}

/* Stats */
.course-stats {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.stat-card {
  background: #f8fafc;
  border-radius: 12px;
  padding: 18px;
  text-align: center;
}

.stat-number {
  font-size: 36px;
  font-weight: 800;
  color: #0f172a;
}

.stat-label {
  font-size: 13px;
  font-weight: 600;
  color: #475569;
}

.stat-sub {
  font-size: 12px;
  color: #64748b;
}

/* Buttons */
.stat-actions {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.btn-primary {
  background: #2563eb;
  color: #ffffff;
  border: none;
  border-radius: 10px;
  padding: 10px;
  font-weight: 600;
}

.btn-secondary {
  background: #f59e0b;
  color: #ffffff;
  border: none;
  border-radius: 10px;
  padding: 10px;
  font-weight: 600;
}

/* Learners */
.learners-section h4 {
  font-weight: 600;
  margin-bottom: 10px;
}

.modern-table {
  width: 100%;
  border-collapse: collapse;
  background: #ffffff;
  border-radius: 12px;
  overflow: hidden;
}

.modern-table th {
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  color: #64748b;
  padding: 12px;
  border-bottom: 1px solid #e5e7eb;
}

.modern-table td {
  padding: 14px 12px;
  font-size: 14px;
  color: #374151;
}

/* Status chips */
.status-chip {
  padding: 4px 12px;
  font-size: 12px;
  font-weight: 600;
  border-radius: 999px;
}

.status-chip.registered {
  background: #ecfdf5;
  color: #065f46;
}

.status-chip.waitlisted {
  background: #fffbeb;
  color: #92400e;
}

/* Empty */
.empty-state,
.empty-table {
  text-align: center;
  color: #64748b;
  padding: 24px;
}
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>course_details_widget</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>Course Details Widget</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function () {

  data.course = {};
  data.registrations = [];

  data.isTrainingUser = gs.hasRole('x_1862243_training.training_user');
  data.isAdmin = gs.hasRole('x_1862243_training.training_admin');
  data.isInstructor = gs.hasRole('x_1862243_training.training_instructor');

  var courseGR = new GlideRecord('x_1862243_training_training_course_table');
  var regGR;

  /* =========================
     REGISTER / WAITLIST
     ========================= */
  if (input && input.action === 'register') {

    data.debug = 'REGISTER BLOCK ENTERED';

    var courseId = input.course_id;
    if (!courseId) {
      data.message = 'Course ID missing';
      return;
    }

    if (!data.isTrainingUser) {
      data.message = 'You do not have permission to register';
      return;
    }

    if (!courseGR.get(courseId)) {
      data.message = 'Course not found';
      return;
    }

    var availableSeats = courseGR.available_seats.nil() ? 0  : parseInt(courseGR.available_seats, 10);

    // Prevent duplicate registration
    regGR = new GlideRecord('x_1862243_training_training_registration_table');
    regGR.addQuery('course', courseId);
    regGR.addQuery('learner', gs.getUserID());
    regGR.query();

    if (regGR.next()) {
      data.message = 'You are already registered for this course.';
      return;
    }

    var statusValue = (availableSeats > 0) ? 'registered' : 'waitlisted';

    var newReg = new GlideRecord('x_1862243_training_training_registration_table');
    newReg.initialize();
    newReg.course = courseId;
    newReg.learner = gs.getUserID();
    newReg.registration_status = statusValue;
    newReg.insert();

    if (statusValue === 'registered') {
      courseGR.available_seats = availableSeats - 1;
      courseGR.update();
    }

    data.message = 'You are ' + statusValue + ' for this course.';
    return;
  }

  /* =========================
     PAGE LOAD
     ========================= */
  var pageCourseId = $sp.getParameter('course_id');
  if (!pageCourseId)
    return;

  if (!courseGR.get(pageCourseId))
    return;

  data.course = {
    sys_id: courseGR.getUniqueValue(),
    name: courseGR.getValue('course_name'),
    code: courseGR.getValue('course_code'),
    description: courseGR.getValue('course_description'),
    instructor: courseGR.getDisplayValue('instructor'),
    duration: courseGR.getValue('duration_hours'),
    category: courseGR.getValue('course_category'),
    maxSeats: parseInt(courseGR.maximum_seats, 10),
    availableSeats: courseGR.available_seats.nil() ? 0 : parseInt(courseGR.available_seats, 10),
    startDate: courseGR.getValue('course_start_date'),
    endDate: courseGR.getValue('course_end_date'),
    location: courseGR.getValue('location'),
    isActive: courseGR.getValue('is_active')
  };

  regGR = new GlideRecord('x_1862243_training_training_registration_table');
  regGR.addQuery('course', pageCourseId);
  regGR.query();

  while (regGR.next()) {
    data.registrations.push({
      learner: regGR.getDisplayValue('learner'),
      status: regGR.getValue('registration_status'),
      regDate: regGR.getValue('registration_date'),
      completionDate: regGR.getValue('completion_date')
    });
  }

})();
]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-11 05:43:25</sys_created_on>
        <sys_id>804dacfa839e721084ade7d0deaad3ca</sys_id>
        <sys_mod_count>66</sys_mod_count>
        <sys_name>Course Details Widget</sys_name>
        <sys_package display_value="Training Registration and Certification Portal" source="x_1862243_training">cd4f29228352721084ade7d0deaad3c0</sys_package>
        <sys_policy/>
        <sys_scope display_value="Training Registration and Certification Portal">cd4f29228352721084ade7d0deaad3c0</sys_scope>
        <sys_update_name>sp_widget_804dacfa839e721084ade7d0deaad3ca</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-14 07:24:27</sys_updated_on>
        <template><![CDATA[<div class="course-container">

  <!-- COURSE HEADER -->
  <div class="course-header">
    <div class="course-title">
      {{data.course.name || 'Select a Course'}}
      <span class="course-code" ng-if="data.course.code">
        {{data.course.code}}
      </span>
    </div>
  </div>

  <!-- COURSE OVERVIEW -->
  <div class="course-overview" ng-if="data.course.sys_id">

    <!-- LEFT INFO -->
    <div class="course-info">
      <p class="course-description">
        {{data.course.description}}
      </p>

      <div class="info-grid">
        <div class="info-item">
          <span class="info-label">Instructor</span>
          <span class="info-value">{{data.course.instructor}}</span>
        </div>

        <div class="info-item">
          <span class="info-label">Category</span>
          <span class="info-chip">{{data.course.category}}</span>
        </div>

        <div class="info-item">
          <span class="info-label">Location</span>
          <span class="info-value">{{data.course.location}}</span>
        </div>

        <div class="info-item">
          <span class="info-label">Duration</span>
          <span class="info-value">{{data.course.duration}} hours</span>
        </div>
      </div>
    </div>

    <!-- RIGHT STATS -->
    <div class="course-stats">
      <div class="stat-card">
        <div class="stat-number">{{data.course.availableSeats}}</div>
        <div class="stat-label">Seats Available</div>
        <div class="stat-sub">of {{data.course.maxSeats}}</div>
      </div>

      <div class="stat-actions" ng-if="data.isTrainingUser">
        <button class="btn-primary"
                ng-click="goToRegistration()"
                ng-disabled="data.course.availableSeats <= 0">
          Register
        </button>

        <button class="btn-secondary"
                ng-show="data.course.availableSeats <= 0"
                ng-click="goToWaitlist()">
          Join Waitlist
        </button>
      </div>
    </div>

  </div>

  <!-- EMPTY STATE -->
  <div class="empty-state" ng-if="!data.course.sys_id">
    Select a course from the list to view details.
  </div>

  <!-- LEARNERS -->
  <div class="learners-section">
    <h4>Registered Learners</h4>

    <table class="modern-table">
      <thead>
        <tr>
          <th>Learner</th>
          <th>Status</th>
          <th>Registered</th>
          <th>Completed</th>
        </tr>
      </thead>
      <tbody>
        <tr ng-repeat="r in data.registrations">
          <td>{{r.learner}}</td>
          <td>
            <span class="status-chip"
                  ng-class="{
                    'registered': r.status === 'registered',
                    'waitlisted': r.status === 'waitlisted'
                  }">
              {{r.status}}
            </span>
          </td>
          <td>{{r.regDate}}</td>
          <td>{{r.completionDate || 'â€”'}}</td>
        </tr>

        <tr ng-if="data.registrations.length === 0">
          <td colspan="4" class="empty-table">
            No learners have registered yet.
          </td>
        </tr>
      </tbody>
    </table>
  </div>

</div>
]]></template>
    </sp_widget>
</record_update>
